---
import Button from './Button.astro';

const galleryImages = [
  { src: '/images/foundation-repair-cost-1.webp', alt: 'Foundation repair before and after', offsetDown: false },
  { src: '/images/foundation-repair-cost-2.webp', alt: 'Concrete lifting results', offsetDown: true },
  { src: '/images/foundation-repair-cost-3.webp', alt: 'Residential foundation work', offsetDown: false },
  { src: '/images/foundation-repair-cost-4.webp', alt: 'Commercial project completion', offsetDown: true }
];
---

<section class="cta">
  <div class="cta__glow-container">
    <div class="cta__glow cta__glow--orange"></div>
    <div class="cta__glow cta__glow--yellow"></div>
  </div>

  <div class="cta__container">
    <!-- Image Gallery -->
    <div class="cta__gallery">
      {galleryImages.map((image, index) => (
        <div class={`cta__gallery-item ${image.offsetDown ? 'cta__gallery-item--offset' : ''} scroll-animate scroll-animate--delay-${index}`}>
          <img src={image.src} alt={image.alt} class="cta__gallery-image" />
        </div>
      ))}
    </div>

    <!-- Main Content -->
    <div class="cta__content">
      <!-- Left Column: Text + Grid -->
      <div class="cta__left">
        <div class="cta__grid-overlay">
          <div class="cta__grid-glow"></div>
          <svg class="cta__grid-svg" viewBox="0 0 600 400" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <pattern id="tightGrid" width="60" height="60" patternUnits="userSpaceOnUse">
                <path d="M 60 0 L 0 0 0 60" fill="none" stroke="rgba(255, 255, 255, 0.15)" stroke-width="1"/>
              </pattern>
              <linearGradient id="gridFade" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="white" stop-opacity="0"/>
                <stop offset="50%" stop-color="white" stop-opacity="0.5"/>
                <stop offset="100%" stop-color="white" stop-opacity="1"/>
              </linearGradient>
              <mask id="gridMask">
                <rect width="100%" height="100%" fill="url(#gridFade)"/>
              </mask>
            </defs>
            <rect width="100%" height="100%" fill="url(#tightGrid)" mask="url(#gridMask)" />
          </svg>
        </div>

        <h2 class="cta__headline scroll-animate scroll-animate--delay-4">
          Foundation Repair Is <span class="cta__headline--highlight">More Affordable</span> Than <span class="cta__headline--highlight">You Think.</span>
        </h2>

        <p class="cta__description scroll-animate scroll-animate--delay-5">
          Most homeowners are surprised to learn that modern polymer injection technology costs significantly less than traditional methodsâ€”and can be completed in days, not weeks.
        </p>
      </div>

      <!-- Right Column: Stats + CTA -->
      <div class="cta__right">
        <div class="cta__stat-box scroll-animate scroll-animate--delay-6">
          <div class="cta__stat-number">30-50%</div>
          <div class="cta__stat-label">Less Than<br />Traditional Piers</div>
        </div>

        <div class="cta__cta-button scroll-animate scroll-animate--delay-7">
          <Button text="Get Free Estimate" size="large" href="/estimate" />
        </div>

        <div class="cta__phone scroll-animate scroll-animate--delay-8">
          <svg class="cta__phone-icon" width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 0.5V18.5M1 9.5H19" stroke="white" stroke-width="1.5"/>
          </svg>
          <span class="cta__phone-text">
            Or Call: <span class="cta__phone-number">(855) 850-5625</span>
          </span>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .cta {
    position: relative;
    background: linear-gradient(108.67deg, #111111 0%, #161616 100%);
    padding: 90px 0;
    overflow: hidden;
  }

  .cta__glow-container {
    position: absolute;
    bottom: -150px;
    right: -150px;
    width: 408px;
    height: 408px;
    pointer-events: none;
    z-index: 0;
    transition: transform 0.6s ease;
  }

  .cta:hover .cta__glow-container {
    transform: scale(1.15);
  }

  .cta__glow {
    position: absolute;
    border-radius: 50%;
    transition: opacity 0.5s ease, filter 0.5s ease;
  }

  .cta__glow--orange {
    width: 408px;
    height: 408px;
    background: var(--color-orange-accent);
    filter: blur(120px);
    opacity: 0.5;
  }

  .cta:hover .cta__glow--orange {
    opacity: 0.7;
    filter: blur(100px);
  }

  .cta__glow--yellow {
    width: 232px;
    height: 232px;
    background: var(--color-orange-yellow);
    filter: blur(58px);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .cta:hover .cta__glow--yellow {
    filter: blur(45px);
  }

  .cta__container {
    max-width: 1452px;
    margin: 0 auto;
    padding: 0 90px;
    position: relative;
    z-index: 1;
  }

  /* Image Gallery */
  .cta__gallery {
    display: flex;
    justify-content: space-between;
    margin-bottom: 80px;
    gap: 30px;
  }

  .cta__gallery-item {
    width: 194px;
    height: 194px;
    flex-shrink: 0;
    overflow: hidden;
    border-radius: 4px;
    position: relative;
    cursor: default;
  }

  .cta__gallery-item::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(250, 117, 35, 0) 0%, rgba(250, 117, 35, 0.15) 100%);
    opacity: 0;
    transition: opacity 0.4s ease;
    pointer-events: none;
    z-index: 1;
  }

  .cta__gallery-item:hover::after {
    opacity: 1;
  }

  .cta__gallery-item--offset {
    margin-top: 50px;
  }

  .cta__gallery-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .cta__gallery-item:hover .cta__gallery-image {
    transform: scale(1.1);
  }

  /* Main Content */
  .cta__content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 100px;
  }

  /* Left Column */
  .cta__left {
    position: relative;
    max-width: 538px;
  }

  .cta__grid-overlay {
    position: absolute;
    top: -40px;
    left: -40px;
    width: calc(100% + 80px);
    height: calc(100% + 80px);
    pointer-events: none;
    z-index: 0;
    opacity: 1;
    transition: opacity 0.4s ease;
  }

  .cta__left:hover .cta__grid-overlay {
    opacity: 0.7;
  }

  .cta__grid-glow {
    display: none;
  }

  .cta__grid-svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transition: transform 0.5s ease;
  }

  .cta__left:hover .cta__grid-svg {
    transform: scale(1.05);
  }

  .cta__headline {
    font-family: var(--font-manrope);
    font-size: 54px;
    font-weight: 400;
    line-height: 120%;
    color: var(--color-gray-medium);
    margin: 0 0 30px 0;
    position: relative;
    z-index: 1;
  }

  .cta__headline--highlight {
    color: var(--color-white);
    position: relative;
    display: inline;
    background-image: linear-gradient(90deg, var(--color-orange-primary), var(--color-orange-light));
    background-size: 0% 3px;
    background-position: 0 100%;
    background-repeat: no-repeat;
    transition: color 0.3s ease, background-size 0.4s ease;
  }

  .cta__headline--highlight:hover {
    color: var(--color-orange-light);
    background-size: 100% 3px;
  }

  .cta__description {
    font-family: var(--font-poppins);
    font-size: 16px;
    font-weight: 400;
    line-height: 24px;
    color: var(--color-gray-medium);
    margin: 0;
    position: relative;
    z-index: 1;
  }

  /* Right Column */
  .cta__right {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 30px;
  }

  .cta__stat-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    cursor: default;
    transition: transform 0.3s ease;
  }

  .cta__stat-box:hover {
    transform: translateY(-5px);
  }

  .cta__stat-number {
    font-family: var(--font-poppins);
    font-size: 52px;
    font-weight: 400;
    line-height: 120%;
    color: var(--color-orange-primary);
    transition: text-shadow 0.3s ease, color 0.3s ease;
  }

  .cta__stat-box:hover .cta__stat-number {
    text-shadow: 0 0 30px rgba(250, 117, 35, 0.5);
    color: var(--color-orange-light);
  }

  .cta__stat-label {
    font-family: var(--font-poppins);
    font-size: 25px;
    font-weight: 400;
    line-height: 120%;
    color: var(--color-white);
    text-align: center;
    max-width: 209px;
    transition: text-shadow 0.3s ease;
  }

  .cta__stat-box:hover .cta__stat-label {
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
  }

  .cta__cta-button {
    margin-top: 10px;
  }

  .cta__phone {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    cursor: default;
    transition: transform 0.3s ease;
  }

  .cta__phone:hover {
    transform: translateX(5px);
  }

  .cta__phone-icon {
    flex-shrink: 0;
    transition: transform 0.3s ease;
  }

  .cta__phone-icon path {
    transition: stroke 0.3s ease;
  }

  .cta__phone:hover .cta__phone-icon {
    transform: rotate(90deg);
  }

  .cta__phone:hover .cta__phone-icon path {
    stroke: var(--color-orange-primary);
  }

  .cta__phone-text {
    font-family: var(--font-poppins);
    font-size: 16px;
    font-weight: 400;
    color: var(--color-gray-medium);
    transition: color 0.3s ease;
  }

  .cta__phone:hover .cta__phone-text {
    color: var(--color-white);
  }

  .cta__phone-number {
    color: var(--color-white);
    transition: color 0.3s ease, text-shadow 0.3s ease;
  }

  .cta__phone:hover .cta__phone-number {
    color: var(--color-orange-primary);
    text-shadow: 0 0 15px rgba(250, 117, 35, 0.3);
  }

  /* Responsive */
  @media (max-width: 1400px) {
    .cta__container {
      padding: 0 60px;
    }

    .cta__content {
      gap: 60px;
    }
  }

  @media (max-width: 1024px) {
    .cta__container {
      padding: 0 40px;
    }

    .cta__gallery {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 60px;
    }

    .cta__gallery-item,
    .cta__gallery-item--offset {
      width: 100%;
      margin-top: 0;
    }

    .cta__content {
      flex-direction: column;
      gap: 50px;
      align-items: flex-start;
    }

    .cta__left {
      max-width: 100%;
    }

    .cta__headline {
      font-size: 42px;
    }

    .cta__right {
      width: 100%;
      align-items: flex-start;
    }

    .cta__stat-box {
      align-items: flex-start;
    }

    .cta__stat-label {
      text-align: left;
    }
  }

  @media (max-width: 768px) {
    .cta {
      padding: 60px 0;
      overflow-x: hidden;
    }

    .cta__container {
      padding: 0 20px;
      overflow-x: hidden;
    }

    .cta__gallery {
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 40px;
    }

    .cta__gallery-item {
      max-width: 300px;
      margin: 0 auto;
    }

    .cta__content {
      align-items: center;
      gap: 40px;
    }

    .cta__left {
      text-align: center;
    }

    .cta__headline {
      font-size: 28px;
      text-align: center;
    }

    .cta__description {
      font-size: 15px;
      line-height: 22px;
      text-align: center;
    }

    .cta__right {
      align-items: center;
      width: 100%;
    }

    .cta__stat-box {
      align-items: center;
    }

    .cta__stat-number {
      font-size: 36px;
    }

    .cta__stat-label {
      font-size: 18px;
      text-align: center;
    }

    .cta__phone {
      flex-direction: column;
      text-align: center;
      gap: 8px;
    }

    .cta__phone-text {
      font-size: 15px;
    }

    .cta__grid-overlay {
      display: none;
    }
  }

  /* Scroll Animations */
  .scroll-animate {
    opacity: 0;
    transform: translateY(40px);
    transition: opacity 0.8s ease-out, transform 0.8s ease-out;
  }

  .scroll-animate--delay-0 {
    transition-delay: 0s;
  }

  .scroll-animate--delay-1 {
    transition-delay: 0.1s;
  }

  .scroll-animate--delay-2 {
    transition-delay: 0.2s;
  }

  .scroll-animate--delay-3 {
    transition-delay: 0.3s;
  }

  .scroll-animate--delay-4 {
    transition-delay: 0.4s;
  }

  .scroll-animate--delay-5 {
    transition-delay: 0.5s;
  }

  .scroll-animate--delay-6 {
    transition-delay: 0.6s;
  }

  .scroll-animate--delay-7 {
    transition-delay: 0.7s;
  }

  .scroll-animate--delay-8 {
    transition-delay: 0.8s;
  }

  .scroll-animate.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* Faster animations on mobile to prevent scroll blocking */
  @media (max-width: 768px) {
    .scroll-animate {
      transform: translateY(20px);
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }

    .scroll-animate--delay-0,
    .scroll-animate--delay-1,
    .scroll-animate--delay-2,
    .scroll-animate--delay-3,
    .scroll-animate--delay-4,
    .scroll-animate--delay-5,
    .scroll-animate--delay-6,
    .scroll-animate--delay-7,
    .scroll-animate--delay-8 {
      transition-delay: 0s;
    }
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .scroll-animate {
      opacity: 1;
      transform: none;
      transition: none;
    }

    .cta__glow-container,
    .cta__glow,
    .cta__gallery-item::after,
    .cta__gallery-image,
    .cta__grid-overlay,
    .cta__grid-svg,
    .cta__headline--highlight,
    .cta__stat-box,
    .cta__stat-number,
    .cta__stat-label,
    .cta__phone,
    .cta__phone-icon,
    .cta__phone-icon path,
    .cta__phone-text,
    .cta__phone-number {
      transition: none;
    }
  }
</style>

<script is:inline>
  (function() {
    var ctaAnimationsInitialized = false;
    var ctaObserver = null;

    function initCTAAnimations() {
      var elements = document.querySelectorAll('.cta .scroll-animate');
      if (elements.length === 0) return;

      // Check if element is in viewport
      function isInViewport(el) {
        var rect = el.getBoundingClientRect();
        var windowHeight = window.innerHeight || document.documentElement.clientHeight;
        return rect.top < windowHeight && rect.bottom > 0;
      }

      // Clean up existing observer
      if (ctaObserver) {
        ctaObserver.disconnect();
      }

      var observerOptions = {
        root: null,
        rootMargin: '0px 0px -30px 0px',
        threshold: 0.05
      };

      ctaObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            ctaObserver.unobserve(entry.target);
          }
        });
      }, observerOptions);

      elements.forEach(function(el) {
        // Reset visibility state if not visible
        if (!el.classList.contains('is-visible')) {
          // Check if already in viewport
          if (isInViewport(el)) {
            // Small delay to ensure CSS is applied first
            setTimeout(function() {
              el.classList.add('is-visible');
            }, 50);
          } else {
            ctaObserver.observe(el);
          }
        }
      });

      ctaAnimationsInitialized = true;
    }

    function runInit() {
      // Double RAF to ensure CSS is painted
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          initCTAAnimations();
        });
      });
    }

    // Run on DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runInit);
    } else {
      runInit();
    }

    // Also run on window load as fallback
    window.addEventListener('load', function() {
      if (!ctaAnimationsInitialized) {
        runInit();
      }
    });

    // Also run on Astro page load (for view transitions)
    document.addEventListener('astro:page-load', function() {
      ctaAnimationsInitialized = false;
      runInit();
    });

    // Scroll fallback - check visibility on scroll
    var scrollTimeout;
    window.addEventListener('scroll', function() {
      if (scrollTimeout) return;
      scrollTimeout = setTimeout(function() {
        scrollTimeout = null;
        var elements = document.querySelectorAll('.cta .scroll-animate:not(.is-visible)');
        if (elements.length === 0) return;

        var windowHeight = window.innerHeight || document.documentElement.clientHeight;
        elements.forEach(function(el) {
          var rect = el.getBoundingClientRect();
          if (rect.top < windowHeight && rect.bottom > 0) {
            el.classList.add('is-visible');
          }
        });
      }, 100);
    }, { passive: true });
  })();
</script>
